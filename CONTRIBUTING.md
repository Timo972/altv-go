# Contributing

Contributing is easy. Just follow the steps below and you are good to go.<br />
You dont nessesarily need to know c++ to contribute to the module. You can also contribute to the go-api or the c-api (which is mostly copying).<br />
Get started by understanding the [architecture](#architecture) of the module.

# Architecture

The go-module is split up into three parts: the [runtime](/runtime), the [c-api](/internal/capi) and the [go-api](/).

| Part    | Language | Description                                                                                                                              |
| ------- | -------- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| Runtime | C++      | The runtime is the core of the module. It is responsible for initializing the go-module ScriptRuntime and loading the resource library.  |
| C-API   | C        | The c-api is the interface between the runtime and the go-api. It is responsible for all go <-> runtime calls                            |
| Go-API  | Go       | The go-api is the api you are using to build your custom gamemode. It utilizes the c-api to call alt:V functions exported by the runtime |

The C-API is currently generated by the [gencapi cli](/cmd/gencapi/).<br />
**DO NOT** edit the c-api files manually, as they will be overwritten on the next build.

# Build from source

Make sure you have installed all **[requirements](https://github.com/timo972/altv-go/wiki/Requirements)**.

At first clone this repository:

```sh
git clone --recurse-submodules https://github.com/timo972/altv-go.git
```

Either follow the [automatic build (make)](#automatic-build) or the [manuall build](#manuall-build) guides.
<br />
<br />
## Automatic build

> requires make

To build the **runtime** and the **c-api** run the following command:

```sh
make
```

[More infos on outputs below](#manuall-build)
<br />
<br />
## Manuall build

If you do not have make installed, you can run the following commands manually:

### To build the runtime:

```sh
./scripts/build-runtime.sh
```

You can find the built runtime library in the folder [`./runtime/bin/libruntime.so` (linux)](/runtime/bin/libgo-module.so) or [`./runtime/bin/Release/go-module.dll` (windows)](/runtime/bin/Release/go-module.dll).
See how to [use your local build](#using-your-local-build) for more information.

### To build the c-api:

```sh
./scripts/build-capi.sh
```

You can find the built c-api library in the folder [`./internal/capi/lib/linux/libcapi.a` (linux)](/internal/capi/lib/linux/libcapi.a) or [`./internal/capi/lib/win32/libcapi.a` (windows)](/internal/capi/lib/win32/libcapi.a). However usually you do not need to touch the built c-api library.
<br />
<br />
## Check / Test capi go api
Run go tests:
```sh
go test -v
```

If this command succeeds everything is compatible and built correctly and you can start using your local version of altv-go.
<br />
<br />
## Using your local altv-go api

To use your local version of the altv-go package, you need to add the following line to the go.mod file **of your resource**:

```
replace github.com/timo972/altv-go => ../relative/path/to/your/altv-go
```

This tells go to use the local version of the package instead of the one hosted on github.
<br />
<br />
## Build the runtime (detailed)
Building the runtime is as easy as running the following command:<br />
```sh
cd ./runtime
# create build and output folder
mkdir build
mkdir bin

cd build

# start build
cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_COMPILER=g++ ..
cmake --build . --config Release

```
See more about runtime build [here](#to-build-the-runtime).
<br />
<br />
## Build the c-api (detailed)

Building the c-api constists of two parts:

- Generation of the c-api header & source file
- Actual build of the c-api using cmake

### Generation of the c-api header & source file

**Generate** the c-api header & source files using `cmd/gencapi`:<br />

```sh
go run cmd/gencapi/*.go -cout=./internal/capi/build/out/capi.c -hout=./internal/capi/build/out/capi.h -hout=./internal/capi/lib/capi.h  ./runtime/src/capi
```

### Build the c-api shared library
This will generate the c-api header & source file in the folder `./internal/capi/build/out/` and copy the header file to `./internal/capi/lib/capi.h`.

**Build** the c-api using cmake:<br />

```sh
cd ./internal/capi
# create build and output folder
mkdir build
mkdir bin

cd build

# start build
cmake ..
cmake --build .
```
See how to test the build [below](#check--test-capi-go-api).

### Checking the build

To check if the build was successful, you can run the following command:<br />
`go test -v`<br />
This will run all tests in the root go package and errors in case the capi is not built correctly or incompatible with the go api.
